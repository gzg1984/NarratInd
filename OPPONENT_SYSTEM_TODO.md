# 反对者系统实现计划

## Phase 1 - 最小可玩版本 ✅ 进行中

### 已确认的设计参数
- **互斥机制**: 方案A（检查已有事件，互斥触发）
- **点击成功率**: `信徒占比 × GDP比率` (复杂乘法)
- **低信徒惩罚**: <10%信徒 → 99%失败，成功率随信徒占比线性增长
- **血条系统**:
  - 基础血条: 100 HP
  - 富国加成: +20 HP (wealthLevel >= 7)
  - 穷国减成: -40 HP (wealthLevel <= 3)
  - 每次点击伤害: 30
  - 压制后未点击3秒恢复: +10 HP
- **脱教惩罚**: 无下限，可能导致全部脱教
- **失败通告**: "你所宣传的思想已经被全世界抛弃，最终湮没在了时间之中。"
- **全局上限**: 
  - 反对者单独上限: 1个
  - 所有特殊事件总上限: 3个

### Phase 1 实现清单
- [ ] 添加反对者事件类型 (OPPONENT)
- [ ] 红色渐变样式 (CSS)
- [ ] 3秒计时机制
- [ ] 简单血条系统 (100基础 + 富/穷调整)
- [ ] 点击成功率判定 (信徒占比 × GDP比率)
- [ ] 脱教者标记 (country.apostates)
- [ ] 传播惩罚计算 (0.5^累积次数)
- [ ] 出现概率公式:
  - 富裕+高信徒: 低概率
  - 贫困+高信徒: 高概率
  - 富裕+低信徒: 高概率
- [ ] 全局事件上限管理 (总计3个)
- [ ] 反对者独立上限 (1个)
- [ ] 失败通告系统

---

## Phase 2 - 完整版本 (待实现)

### 邻国传染机制
**设计**:
- 未被点击消灭的反对者，为所在国家设置"传染标记"
- 标记持续时间: 3-5回合
- 邻国（陆地/海运/空运可达）下回合反对者概率 ×2.5

**实现要点**:
```javascript
// country对象添加字段
opponentInfection: {
  active: false,
  turnsRemaining: 0,
  sourceCountryId: null
}

// 传染逻辑
- 反对者存活3秒 → 标记源国家
- checkForEvents时检查邻国是否被标记
- 被标记国家的邻国: probability *= 2.5
```

### 压制复活逻辑
**设计**:
- 反对者被击败但health > 0 → "压制状态"
- 压制期间: 暂时消失
- 复活机制:
  - 3-5回合后有概率复活
  - 复活时health恢复50%
  - 复活概率与国家GDP和信徒占比相关

**实现要点**:
```javascript
// country对象添加压制记录
suppressedOpponents: [
  {
    opponentId: 'opp_123',
    health: 40,
    suppressedTurn: 15,
    reviveChance: 0.3
  }
]

// 每回合检查
- 检查压制列表中的反对者
- turnsSinceSuppressed >= 3 → 复活检测
- 复活成功 → 重新生成事件
```

### 高级点击反馈
**设计**:
- 点击失败: 显示"失败！"红色文字
- 点击成功但未消灭: 显示"-30 HP" (黄色)
- 完全消灭: 显示"已消灭！" (绿色)
- 压制: 显示"暂时压制" (蓝色)

### 脱教者详细统计
**设计**:
- InfoBar显示脱教者总数
- 每个国家显示脱教率
- 鼠标悬停国家显示传播惩罚百分比

---

## 技术笔记

### 关键文件修改
1. `SpecialEvents.js`: 添加OPPONENT事件类型
2. `style.css`: 红色渐变样式
3. `countryData.js`: 添加apostates, opponentInfection字段
4. `events.js`: 传播事件中应用脱教惩罚
5. `gameState.js`: 失败检测和通告

### 测试要点
- [ ] 反对者在贫困高信徒国家频繁出现
- [ ] 富裕高信徒国家很少出现
- [ ] 点击成功率符合预期
- [ ] 3秒未点击导致信徒大量流失
- [ ] 脱教者累积后传播明显变慢
- [ ] 全局上限生效（最多3个特殊事件）
- [ ] 反对者最多1个

### 数值平衡
```javascript
// 反对者出现概率基础公式
baseChance = 0.05  // 5%基础

// 修正系数
富裕(GDP比率>0.7) + 高信徒(>70%): × 0.3
贫困(GDP比率<0.3) + 高信徒(>70%): × 3.0
富裕(GDP比率>0.7) + 低信徒(<30%): × 2.0

// 点击成功率
successRate = believerRatio × gdpRatio
例: 80%信徒 × 20%GDP = 16%成功率

// 伤害计算
baseDamage = 30
criticalHit = 50 (10%概率，可选)
```

---

## 未来扩展想法
- 反对者类型多样化 (激进派、温和派、学者)
- 反对者联盟 (多个反对者互相增强)
- 玩家可购买"舆论控制"技能降低反对者出现
- 反对者可以"逃亡"到邻国继续活动
